<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نمایش مسیر مامور قرائت - نسخه ساده</title>
    
    <!-- Vazirmatn Font -->
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- SheetJS (xlsx) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        :root {
            --primary-color: #2563eb;
            --primary-hover: #1d4ed8;
            --success-color: #22c55e;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --bg-primary: #f8fafc;
            --bg-secondary: #f1f5f9;
            --border-color: #e2e8f0;
        }

        body {
            font-family: 'Vazirmatn', system-ui, -apple-system, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
        }
        
        * {
            box-sizing: border-box;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1), 0 1px 2px -1px rgba(0,0,0,0.1);
        }
        
        h1, h2, h3 {
            font-family: 'Vazirmatn', system-ui, -apple-system, sans-serif;
            font-weight: 700;
            color: var(--text-primary);
            margin-top: 0;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        h1 {
            font-size: 1.875rem;
            text-align: center;
            margin-bottom: 24px;
        }

        h2 {
            font-size: 1.5rem;
            margin-bottom: 20px;
        }

        h3 {
            font-size: 1.25rem;
        }
        
        .section {
            padding: 20px;
            margin-bottom: 24px;
            border-radius: 12px;
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }
        
        #upload-section {
            text-align: center;
            border: 2px dashed var(--primary-color);
            background-color: rgba(37, 99, 235, 0.05);
            padding: 32px;
        }
        
        #upload-section:hover {
            background-color: rgba(37, 99, 235, 0.1);
        }
        
        .hidden {
            display: none;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 16px;
            font-family: 'Vazirmatn';
            font-size: 0.95rem;
            color: var(--text-primary);
            background-color: white;
            transition: all 0.2s ease;
        }

        select:hover {
            border-color: var(--primary-color);
        }

        select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
        }
        
        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'Vazirmatn';
            font-weight: 500;
            font-size: 0.95rem;
        }
        
        button:hover {
            background-color: var(--primary-hover);
            transform: translateY(-1px);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        
        #map {
            height: 500px;
            width: 100%;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            margin-bottom: 16px;
        }
        
        .info-box {
            background-color: white;
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
            border: 1px solid var(--border-color);
            font-size: 0.95rem;
        }
        
        .status {
            padding: 12px 16px;
            margin: 12px 0;
            border-radius: 8px;
            font-size: 0.95rem;
        }
        
        .success {
            background-color: rgba(34, 197, 94, 0.1);
            color: #166534;
            border: 1px solid rgba(34, 197, 94, 0.2);
        }
        
        .error {
            background-color: rgba(239, 68, 68, 0.1);
            color: #991b1b;
            border: 1px solid rgba(239, 68, 68, 0.2);
        }
        
        .warning {
            background-color: rgba(245, 158, 11, 0.1);
            color: #92400e;
            border: 1px solid rgba(245, 158, 11, 0.2);
        }
        
        .control-panel {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }
        
        .control-panel button {
            flex: 1;
        }
        
        #animate-btn {
            background-color: var(--success-color);
        }
        
        #animate-btn:hover {
            background-color: #16a34a;
        }
        
        #reset-btn {
            background-color: var(--danger-color);
        }
        
        #reset-btn:hover {
            background-color: #dc2626;
        }
        
        .marker-green, .marker-blue, .marker-red {
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 0 2px rgba(0,0,0,0.2);
        }

        .marker-green { background-color: var(--success-color); }
        .marker-blue { background-color: var(--primary-color); }
        .marker-red { background-color: var(--danger-color); }
        
        .loader {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid rgba(37, 99, 235, 0.2);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
            margin-left: 12px;
            vertical-align: middle;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .points-report {
            margin-top: 24px;
            background-color: white;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border-color);
        }
        
        .points-list {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 12px;
            margin-top: 16px;
        }

        .points-list::-webkit-scrollbar {
            width: 8px;
        }

        .points-list::-webkit-scrollbar-track {
            background: var(--bg-secondary);
            border-radius: 4px;
        }

        .points-list::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 4px;
        }
        
        .point-item {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 8px;
            border-radius: 8px;
            transition: all 0.2s ease;
            cursor: pointer;
            background-color: white;
        }
        
        .point-item:hover {
            background-color: var(--bg-secondary);
            transform: translateX(-4px);
        }
        
        .point-item.active {
            background-color: rgba(37, 99, 235, 0.1);
            border-right: 4px solid var(--primary-color);
        }
        
        .point-time {
            font-weight: 600;
            color: var(--primary-color);
            font-size: 1rem;
        }
        
        .point-subscriber {
            color: var(--text-secondary);
            margin: 4px 0;
        }
        
        .point-coords {
            color: var(--text-secondary);
            font-size: 0.875rem;
            direction: ltr;
            text-align: left;
            font-family: monospace;
        }
        
        .start-point {
            background-color: rgba(34, 197, 94, 0.1);
            border-right: 4px solid var(--success-color);
        }
        
        .end-point {
            background-color: rgba(239, 68, 68, 0.1);
            border-right: 4px solid var(--danger-color);
        }

        input[type="file"] {
            display: none;
        }

        .file-input-label {
            display: inline-block;
            padding: 12px 24px;
            background-color: white;
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 16px;
        }

        .file-input-label:hover {
            background-color: var(--primary-color);
            color: white;
        }

        .file-name {
            margin-top: 8px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        @media (max-width: 768px) {
            .container {
                padding: 16px;
            }

            .control-panel {
                flex-direction: column;
            }

            .section {
                padding: 16px;
            }

            #map {
                height: 400px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>نمایش مسیر مامور قرائت</h1>
        
        <div id="upload-section" class="section">
            <h2>بارگذاری فایل اکسل</h2>
            <p>فایل اکسل شامل اطلاعات مأمورین و مسیر قرائت را انتخاب کنید:</p>
            <input type="file" id="excel-file" accept=".xlsx,.xls" />
            <label for="excel-file" class="file-input-label">انتخاب فایل اکسل</label>
            <div class="file-name"></div>
            <button id="load-btn">بارگذاری اطلاعات</button>
            <p class="warning">توجه: فایل اکسل باید شامل ستون‌های C (نام مامور)، D (نام انشعاب)، E (تاریخ)، F (ساعت) و Q (مختصات) باشد.<br>
            داده‌ها از ردیف 4 شروع می‌شوند.</p>
            <div id="status" class="status hidden"></div>
        </div>
        
        <div id="filter-section" class="section hidden">
            <h2>انتخاب فیلترها</h2>
            <div>
                <label for="date-select">انتخاب تاریخ:</label>
                <select id="date-select">
                    <option value="">-- تاریخ را انتخاب کنید --</option>
                </select>
            </div>
            <div>
                <label for="officer-select">انتخاب مامور:</label>
                <select id="officer-select">
                    <option value="">-- مامور را انتخاب کنید --</option>
                </select>
            </div>
            <button id="show-map-btn">نمایش روی نقشه</button>
        </div>
        
        <div id="map-section" class="section hidden">
            <h2>نمایش مسیر روی نقشه</h2>
            <div id="map"></div>
            <div class="control-panel">
                <button id="animate-btn">نمایش انیمیشن مسیر</button>
                <button id="reset-btn">بازنشانی نقشه</button>
                <button id="export-btn">دریافت خروجی CSV</button>
            </div>
            <div id="info-box" class="info-box"></div>
            
            <div id="points-report" class="points-report hidden">
                <h3>گزارش نقاط ثبت شده</h3>
                <div id="points-list" class="points-list"></div>
            </div>
        </div>
    </div>
    
    <script>
        // متغیرهای اصلی
        let excelData = [];
        let map;
        let markers = [];
        let pathLine;
        let animation;
        
        // دسترسی به عناصر صفحه
        const excelFileInput = document.getElementById('excel-file');
        const loadButton = document.getElementById('load-btn');
        const dateSelect = document.getElementById('date-select');
        const officerSelect = document.getElementById('officer-select');
        const showMapButton = document.getElementById('show-map-btn');
        const animateButton = document.getElementById('animate-btn');
        const resetButton = document.getElementById('reset-btn');
        const exportButton = document.getElementById('export-btn');
        const statusElement = document.getElementById('status');
        const filterSection = document.getElementById('filter-section');
        const mapSection = document.getElementById('map-section');
        const infoBox = document.getElementById('info-box');
        
        // تبدیل اعداد فارسی به انگلیسی
        function convertPersianToEnglish(text) {
            if (!text) return text;
            
            const persianDigits = ['۰', '۱', '۲', '۳', '۴', '۵', '۶', '۷', '۸', '۹'];
            return text.toString().replace(/[۰-۹]/g, d => persianDigits.indexOf(d));
        }
        
        // تجزیه مختصات جغرافیایی
        function parseCoordinates(coordStr) {
            if (!coordStr) return null;
            
            const parts = coordStr.split(',');
            if (parts.length !== 2) return null;
            
            const lat = parseFloat(parts[0]);
            const lng = parseFloat(parts[1]);
            
            if (isNaN(lat) || isNaN(lng)) return null;
            
            return [lat, lng];
        }
        
        // تجزیه تاریخ فارسی
        function parsePersianDate(dateStr, timeStr) {
            if (!dateStr) return null;
            
            // تبدیل اعداد فارسی به انگلیسی
            const englishDateStr = convertPersianToEnglish(dateStr);
            const parts = englishDateStr.split('/');
            
            if (parts.length !== 3) return null;
            
            // تاریخ فارسی به فرمت YYYY/MM/DD
            const year = parseInt(parts[0]);
            const month = parseInt(parts[1]) - 1;
            const day = parseInt(parts[2]);
            
            let hours = 0, minutes = 0, seconds = 0;
            
            if (timeStr) {
                const timeParts = timeStr.split(':');
                hours = parseInt(timeParts[0] || 0);
                minutes = parseInt(timeParts[1] || 0);
                seconds = parseInt(timeParts[2] || 0);
            }
            
            // ایجاد شیء تاریخ
            return new Date(year, month, day, hours, minutes, seconds);
        }
        
        // پردازش فایل اکسل
        function processExcelFile(file) {
            showStatus('در حال پردازش فایل...', 'warning');
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // استفاده از اولین شیت
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // تبدیل به JSON با استفاده از نام‌های ستون به عنوان حروف
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 'A' });
                    
                    // پردازش داده‌ها
                    processData(jsonData);
                } catch (error) {
                    showStatus('خطا در پردازش فایل: ' + error.message, 'error');
                }
            };
            
            reader.onerror = function() {
                showStatus('خطا در خواندن فایل.', 'error');
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        // پردازش داده‌های استخراج شده
        function processData(jsonData) {
            excelData = [];
            const dates = new Set();
            const officers = new Set();
            
            let total = 0;
            let valid = 0;
            let invalidCoords = 0;
            let invalidDates = 0;
            
            // شروع از ردیف 4 (با توجه به شروع ردیف از 0)
            for (let i = 3; i < jsonData.length; i++) {
                const row = jsonData[i];
                
                // بررسی وجود فیلدهای ضروری
                if (!row.C || !row.E || !row.Q) continue;
                
                total++;
                
                const officerName = row.C;
                const subscriberName = row.D;
                const persianDate = row.E;
                const time = row.F;
                const coordinates = row.Q;
                
                // تجزیه مختصات
                const coordArray = parseCoordinates(coordinates);
                if (!coordArray) {
                    invalidCoords++;
                    continue;
                }
                
                // تجزیه تاریخ
                const date = parsePersianDate(persianDate, time);
                if (!date) {
                    invalidDates++;
                    continue;
                }
                
                // افزودن به مجموعه‌های منحصر به فرد
                officers.add(officerName);
                dates.add(persianDate);
                
                // افزودن به داده‌های پردازش شده
                excelData.push({
                    officer: officerName,
                    subscriber: subscriberName,
                    persianDate: persianDate,
                    time: time,
                    date: date,
                    coordinates: coordArray
                });
                
                valid++;
            }
            
            if (valid === 0) {
                showStatus('هیچ رکورد معتبری یافت نشد. لطفاً ساختار فایل اکسل را بررسی کنید.', 'error');
                return;
            }
            
            showStatus(`
                ${valid} رکورد معتبر از ${total} رکورد پردازش شد.<br>
                ${invalidCoords} رکورد دارای مختصات نامعتبر<br>
                ${invalidDates} رکورد دارای تاریخ نامعتبر<br>
                ${dates.size} تاریخ و ${officers.size} مامور متمایز شناسایی شد.
            `, 'success');
            
            // پر کردن فیلترها
            populateFilters([...dates], [...officers]);
            
            // نمایش بخش فیلتر
            filterSection.classList.remove('hidden');
        }
        
        // پر کردن فیلترها
        function populateFilters(dates, officers) {
            // مرتب‌سازی تاریخ‌ها و نام‌های مامور
            dates.sort();
            officers.sort();
            
            // پاک کردن مقادیر قبلی
            dateSelect.innerHTML = '<option value="">-- تاریخ را انتخاب کنید --</option>';
            officerSelect.innerHTML = '<option value="">-- مامور را انتخاب کنید --</option>';
            
            // افزودن تاریخ‌ها
            dates.forEach(date => {
                const option = document.createElement('option');
                option.value = date;
                option.textContent = date;
                dateSelect.appendChild(option);
            });
            
            // افزودن مامورین
            officers.forEach(officer => {
                const option = document.createElement('option');
                option.value = officer;
                option.textContent = officer;
                officerSelect.appendChild(option);
            });
        }
        
        // نمایش وضعیت
        function showStatus(message, type) {
            statusElement.innerHTML = message;
            statusElement.className = 'status ' + type;
            statusElement.classList.remove('hidden');
        }
        
        // آماده‌سازی نقشه
        function initMap() {
            if (map) {
                map.remove();
            }
            
            map = L.map('map').setView([29.5926, 52.5836], 12);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
        }
        
        // نمایش مسیر روی نقشه
        function displayPath() {
            const selectedDate = dateSelect.value;
            const selectedOfficer = officerSelect.value;
            
            if (!selectedDate || !selectedOfficer) {
                alert('لطفاً تاریخ و مامور را انتخاب کنید.');
                return;
            }
            
            // فیلتر داده‌ها
            const filteredData = excelData.filter(item => 
                item.persianDate === selectedDate && 
                item.officer === selectedOfficer
            );
            
            if (filteredData.length === 0) {
                alert('هیچ داده‌ای برای نمایش یافت نشد.');
                return;
            }
            
            // مرتب‌سازی بر اساس زمان
            filteredData.sort((a, b) => a.date - b.date);
            
            // نمایش بخش نقشه
            mapSection.classList.remove('hidden');
            document.getElementById('points-report').classList.remove('hidden');
            
            // آماده‌سازی نقشه
            initMap();
            
            // نمایش نقاط و مسیر
            showMarkersAndPath(filteredData);
            
            // به‌روزرسانی اطلاعات
            updateInfoBox(filteredData);
            
            // نمایش گزارش نقاط
            showPointsList(filteredData);
        }
        
        // پاک کردن نقشه
        function clearMap() {
            // حذف نشانگرها
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            
            // حذف خط مسیر
            if (pathLine) {
                map.removeLayer(pathLine);
                pathLine = null;
            }
        }
        
        // نمایش نقاط و مسیر
        function showMarkersAndPath(data) {
            // پاک کردن نقشه
            clearMap();
            
            const latlngs = [];
            
            // افزودن نشانگرها
            data.forEach((point, index) => {
                const [lat, lng] = point.coordinates;
                latlngs.push([lat, lng]);
                
                // تعیین رنگ نشانگر بر اساس موقعیت
                let className, tooltipText;
                
                if (index === 0) {
                    // نقطه شروع - سبز
                    className = 'marker-green';
                    tooltipText = 'شروع: ' + point.time;
                } else if (index === data.length - 1) {
                    // نقطه پایان - قرمز
                    className = 'marker-red';
                    tooltipText = 'پایان: ' + point.time;
                } else {
                    // نقاط میانی - آبی
                    className = 'marker-blue';
                    tooltipText = point.time;
                }
                
                // ایجاد آیکون سفارشی
                const icon = L.divIcon({
                    className: className,
                    html: `<div style="width: 12px; height: 12px;"></div>`,
                    iconSize: [12, 12],
                    iconAnchor: [6, 6]
                });
                
                // ایجاد نشانگر
                const marker = L.marker([lat, lng], { icon: icon })
                    .addTo(map)
                    .bindPopup(`
                        <strong>مامور:</strong> ${point.officer}<br>
                        <strong>مشترک:</strong> ${point.subscriber || 'نامشخص'}<br>
                        <strong>زمان:</strong> ${point.time}<br>
                        <strong>مختصات:</strong> ${lat}, ${lng}
                    `);
                
                // افزودن شناسه برای ارتباط با لیست
                marker.pointIndex = index;
                
                markers.push(marker);
            });
            
            // ایجاد خط مسیر
            pathLine = L.polyline(latlngs, { color: 'blue', weight: 3, opacity: 0.7 }).addTo(map);
            
            // ذخیره نقاط برای انیمیشن
            pathLine.latlngs = latlngs;
            
            // نمایش همه نقاط در نقشه
            if (latlngs.length > 0) {
                map.fitBounds(L.latLngBounds(latlngs));
            }
        }
        
        // به‌روزرسانی جعبه اطلاعات
        function updateInfoBox(data) {
            const startTime = data[0].time;
            const endTime = data[data.length - 1].time;
            const count = data.length;
            
            infoBox.innerHTML = `
                <strong>تعداد نقاط:</strong> ${count} |
                <strong>زمان شروع:</strong> ${startTime} |
                <strong>زمان پایان:</strong> ${endTime} |
                <strong>مامور:</strong> ${data[0].officer} |
                <strong>تاریخ:</strong> ${data[0].persianDate}
            `;
        }
        
        // نمایش لیست نقاط
        function showPointsList(data) {
            const pointsList = document.getElementById('points-list');
            pointsList.innerHTML = '';
            
            data.forEach((point, index) => {
                const [lat, lng] = point.coordinates;
                
                // ایجاد آیتم جدید برای هر نقطه
                const listItem = document.createElement('div');
                listItem.className = 'point-item';
                
                // نقطه شروع یا پایان؟
                if (index === 0) {
                    listItem.classList.add('start-point');
                } else if (index === data.length - 1) {
                    listItem.classList.add('end-point');
                }
                
                listItem.innerHTML = `
                    <div class="point-time">${index + 1}. ${point.time} ${index === 0 ? '(شروع)' : index === data.length - 1 ? '(پایان)' : ''}</div>
                    <div class="point-subscriber">انشعاب: ${point.subscriber || 'نامشخص'}</div>
                    <div class="point-coords">مختصات: ${lat}, ${lng}</div>
                `;
                
                // اضافه کردن رویداد کلیک روی آیتم لیست
                listItem.addEventListener('click', () => {
                    // پاک کردن کلاس active از همه آیتم‌ها
                    document.querySelectorAll('.point-item').forEach(item => {
                        item.classList.remove('active');
                    });
                    
                    // اضافه کردن کلاس active به آیتم انتخاب شده
                    listItem.classList.add('active');
                    
                    // نمایش پاپ‌آپ نشانگر
                    if (markers[index]) {
                        map.setView(point.coordinates, map.getZoom());
                        markers[index].openPopup();
                    }
                });
                
                pointsList.appendChild(listItem);
            });
        }
        
        // انیمیشن مسیر
        function animatePath() {
            // بررسی وجود داده
            if (!pathLine || !pathLine.latlngs || pathLine.latlngs.length === 0) return;
            
            // پاک کردن انیمیشن قبلی
            clearAnimation();
            
            // غیرفعال کردن دکمه انیمیشن
            animateButton.disabled = true;
            
            // بازنشانی خط مسیر
            pathLine.setLatLngs([]);
            
            // شروع انیمیشن
            let index = 0;
            animation = setInterval(() => {
                // افزودن نقطه بعدی
                const currentPath = pathLine.getLatLngs();
                currentPath.push(pathLine.latlngs[index]);
                pathLine.setLatLngs(currentPath);
                
                // مرکز نقشه روی نقطه فعلی
                map.panTo(pathLine.latlngs[index]);
                
                // نمایش پاپ‌آپ نقطه فعلی
                if (markers[index]) {
                    markers[index].openPopup();
                    
                    // بستن پاپ‌آپ قبلی
                    if (index > 0 && markers[index-1]) {
                        markers[index-1].closePopup();
                    }
                }
                
                // فعال کردن آیتم متناظر در لیست
                const pointItems = document.querySelectorAll('.point-item');
                
                // پاک کردن کلاس active از همه آیتم‌ها
                pointItems.forEach(item => {
                    item.classList.remove('active');
                });
                
                // اضافه کردن کلاس active به آیتم فعلی
                if (pointItems[index]) {
                    pointItems[index].classList.add('active');
                    pointItems[index].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
                
                index++;
                
                // پایان انیمیشن
                if (index >= pathLine.latlngs.length) {
                    clearAnimation();
                    animateButton.disabled = false;
                }
            }, 500); // سرعت انیمیشن
        }
        
        // پاک کردن انیمیشن
        function clearAnimation() {
            if (animation) {
                clearInterval(animation);
                animation = null;
            }
            
            // بستن همه پاپ‌آپ‌ها
            markers.forEach(marker => marker.closePopup());
            
            // پاک کردن کلاس active از همه آیتم‌های لیست
            document.querySelectorAll('.point-item').forEach(item => {
                item.classList.remove('active');
            });
        }
        
        // بازنشانی مسیر
        function resetPath() {
            // پاک کردن انیمیشن
            clearAnimation();
            
            // فعال کردن دکمه انیمیشن
            animateButton.disabled = false;
            
            // نمایش کل مسیر
            if (pathLine && pathLine.latlngs) {
                pathLine.setLatLngs(pathLine.latlngs);
                
                // نمایش همه نقاط در نقشه
                if (pathLine.latlngs.length > 0) {
                    map.fitBounds(L.latLngBounds(pathLine.latlngs));
                }
            }
        }
        
        // صدور خروجی CSV
        function exportCSV() {
            const selectedDate = dateSelect.value;
            const selectedOfficer = officerSelect.value;
            
            if (!selectedDate || !selectedOfficer) {
                alert('لطفاً تاریخ و مامور را انتخاب کنید.');
                return;
            }
            
            // فیلتر داده‌ها
            const filteredData = excelData.filter(item => 
                item.persianDate === selectedDate && 
                item.officer === selectedOfficer
            );
            
            if (filteredData.length === 0) {
                alert('هیچ داده‌ای برای صدور وجود ندارد.');
                return;
            }
            
            // مرتب‌سازی بر اساس زمان
            filteredData.sort((a, b) => a.date - b.date);
            
            // آماده‌سازی محتوای CSV
            let csvContent = "data:text/csv;charset=utf-8,";
            
            // افزودن سرصفحه
            csvContent += "ردیف,نام مامور,نام انشعاب,تاریخ,ساعت,عرض جغرافیایی,طول جغرافیایی\n";
            
            // افزودن ردیف‌ها
            filteredData.forEach((item, index) => {
                const row = [
                    index + 1,
                    item.officer,
                    item.subscriber || "",
                    item.persianDate,
                    item.time,
                    item.coordinates[0],
                    item.coordinates[1]
                ].join(",");
                csvContent += row + "\n";
            });
            
            // ایجاد لینک دانلود
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `مسیر_${selectedOfficer}_${selectedDate.replace(/\//g, "-")}.csv`);
            document.body.appendChild(link);
            
            // شروع دانلود
            link.click();
            
            // پاک‌سازی
            document.body.removeChild(link);
        }
        
        // رویدادها
        loadButton.addEventListener('click', () => {
            const file = excelFileInput.files[0];
            
            if (!file) {
                alert('لطفاً یک فایل اکسل انتخاب کنید.');
                return;
            }
            
            processExcelFile(file);
        });
        
        showMapButton.addEventListener('click', displayPath);
        animateButton.addEventListener('click', animatePath);
        resetButton.addEventListener('click', resetPath);
        exportButton.addEventListener('click', exportCSV);
        
        // اضافه کردن نمایش نام فایل انتخاب شده
        excelFileInput.addEventListener('change', function() {
            const fileName = this.files[0]?.name;
            const fileNameElement = document.querySelector('.file-name');
            if (fileName) {
                fileNameElement.textContent = fileName;
            } else {
                fileNameElement.textContent = '';
            }
        });
    </script>
</body>
</html> 